import './polyfills.server.mjs';
import{a as b,b as k}from"./chunk-XSJAQIIE.mjs";import{I as g,L as m,Ob as i,Q as l,c as f,f as d,j as c,oa as u,u as p}from"./chunk-U5GYFHMI.mjs";var a=class extends Error{};a.prototype.name="InvalidTokenError";function w(o){return decodeURIComponent(atob(o).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function v(o){let e=o.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return w(e)}catch{return atob(e)}}function S(o,e){if(typeof o!="string")throw new a("Invalid token specified: must be a string");e||(e={});let t=e.header===!0?0:1,r=o.split(".")[t];if(typeof r!="string")throw new a(`Invalid token specified: missing part #${t+1}`);let n;try{n=v(r)}catch(s){throw new a(`Invalid token specified: invalid base64 for part #${t+1} (${s.message})`)}try{return JSON.parse(n)}catch(s){throw new a(`Invalid token specified: invalid json for part #${t+1} (${s.message})`)}}var h={production:!0,apiUrl:"/api"};var I=class o{constructor(e,t){this.http=e;this.platformId=t}socket=null;messagesSubject=new d;Date="";userInfo;userid;baseUrl=h.apiUrl;authenticationUrl=`${h.apiUrl}/authentication/`;refreshToken(){if(!i(this.platformId))return c(null);let e=localStorage.getItem("refresh");return console.log(e),e?this.http.post(this.authenticationUrl+"token/refresh/",{refresh:e}).pipe(g(t=>{t&&t.access&&(localStorage.setItem("token",t.access),t.refresh&&localStorage.setItem("refresh",t.refresh),this.decodeDate())}),p(t=>(console.error("Token refresh failed",t),c(null)))):c(null)}register(e){return this.http.post(this.authenticationUrl+"registration/",e)}login(e){return this.http.post(this.authenticationUrl+"login/",e)}decodeDate(){if(i(this.platformId)){let e=localStorage.getItem("token"),t=localStorage.getItem("user_id");e&&(this.userInfo=S(e)),t&&(this.userid=t,console.log("id",this.userid))}}createNewChat(){let e;if(i(this.platformId)&&(e=localStorage.getItem("token")),!e)return console.error("\u274C No token found! Cannot create chat."),new f(r=>{r.error("No token available.")});let t=new b({Authorization:`JWT ${e}`});return this.http.post(this.baseUrl+"/chat/rooms/",{},{headers:t})}connectToWebSocket(){let e,t;if(i(this.platformId)&&(e=localStorage.getItem("token"),t=localStorage.getItem("chatId"),console.log("id_chat",t)),!e||!t){console.error("\u274C No token or chat ID found!");return}let r=`wss://api.ariflawfirm.com/ws/chat/${t}/?authorization=JWT ${e}`;this.socket=new WebSocket(r),this.socket.onopen=()=>console.log("\u2705 WebSocket connected"),this.socket.onmessage=n=>{try{let s=JSON.parse(n.data);s.message?.user==null?(this.messagesSubject.next(s.message.message),this.Date=s.message.date):console.warn("\u26A0\uFE0F Unrecognized WebSocket message format:",s)}catch(s){console.error("\u274C Error parsing WebSocket message:",s)}},this.socket.onerror=n=>console.error("\u{1F6A8} WebSocket Error:",n),this.socket.onclose=n=>{console.log("\u274C WebSocket disconnected",n.reason),setTimeout(()=>this.connectToWebSocket(),5e3)}}sendMessage(e){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(JSON.stringify({message:e})):console.error("\u274C WebSocket is not open. Cannot send message.")}getMessages(){return this.messagesSubject.asObservable()}disconnect(){this.socket&&(this.socket.close(),console.log("WebSocket manually disconnected"))}static \u0275fac=function(t){return new(t||o)(l(k),l(u))};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};export{I as a};
